<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- Héritage de la vue liste des mouvements détaillés -->
    <record id="view_stock_move_line_list_inherit_qty" model="ir.ui.view">
        <field name="name">stock.move.line.list.inherit.qty</field>
        <field name="model">stock.move.line</field>
        <field name="inherit_id" ref="stock.view_move_line_tree"/>
        <field name="arch" type="xml">
            <xpath expr="//field[@name='quantity']" position="before">
                <field name="x_qty_before" string="Qté avant" optional="show"/>
            </xpath>
            <xpath expr="//field[@name='quantity']" position="after">
                <field name="x_qty_after" string="Qté après" optional="show"/>
            </xpath>
        </field>
    </record>

    <!-- Héritage de la vue formulaire des mouvements détaillés -->
    <record id="view_stock_move_line_form_inherit_qty" model="ir.ui.view">
        <field name="name">stock.move.line.form.inherit.qty</field>
        <field name="model">stock.move.line</field>
        <field name="inherit_id" ref="stock.view_move_line_form"/>
        <field name="arch" type="xml">
            <xpath expr="//field[@name='quantity']" position="before">
                <field name="x_qty_before" string="Quantité avant" readonly="1"/>
            </xpath>
            <xpath expr="//field[@name='quantity']" position="after">
                <field name="x_qty_after" string="Quantité après" readonly="1"/>
            </xpath>
        </field>
    </record>

    <!-- Vue liste dédiée historique des mouvements avec qty avant/après -->
    <record id="view_stock_move_line_history_list" model="ir.ui.view">
        <field name="name">stock.move.line.history.list</field>
        <field name="model">stock.move.line</field>
        <field name="arch" type="xml">
            <list string="Historique mouvements de stock" default_order="date desc, id desc" create="false" edit="false" delete="false">
                <field name="date" string="Date"/>
                <field name="reference" string="Référence"/>
                <field name="product_id" string="Produit"/>
                <field name="lot_id" string="Lot/N° série" optional="show"/>
                <field name="location_id" string="De"/>
                <field name="location_dest_id" string="Vers"/>
                <field name="x_qty_before" string="Qté avant" decoration-info="True"/>
                <field name="quantity" string="Qté déplacée"/>
                <field name="x_qty_after" string="Qté après" decoration-success="True"/>
                <field name="product_uom_id" string="UdM" optional="hide"/>
                <field name="state" string="État" optional="hide"/>
            </list>
        </field>
    </record>

    <!-- Action dédiée pour l'historique -->
    <record id="action_stock_move_line_history_qty" model="ir.actions.act_window">
        <field name="name">Historique mouvements (Qté avant/après)</field>
        <field name="res_model">stock.move.line</field>
        <field name="view_mode">list,form</field>
        <field name="view_id" ref="view_stock_move_line_history_list"/>
        <field name="domain">[('state', '=', 'done')]</field>
        <field name="context">{'search_default_group_by_product': 0}</field>
    </record>

    <!-- Menu dans Inventaire > Reporting -->
    <menuitem id="menu_stock_move_line_history_qty"
              name="Mouvements Qté avant/après"
              parent="stock.menu_stock_reports"
              action="action_stock_move_line_history_qty"
              sequence="50"/>
</odoo>
